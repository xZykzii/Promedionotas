<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promedios UBB</title>

    <!-- MANIFEST → rutas absolutas para subcarpeta -->
    <link rel="manifest" href="/Promedionotas/manifest.json">

    <!-- Favicon -->
    <link rel="icon" href="/Promedionotas/icons/icon-192.png">

    <!-- SERVICE WORKER -->
    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("/Promedionotas/sw.js");
            });
        }
    </script>

    <style>
        body {
            background: #0d0d0d;
            color: #ffffff;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        header {
            padding: 20px;
            text-align: center;
            font-size: 26px;
            background: #111;
            border-bottom: 2px solid #444;
        }

        nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 10px;
            background: #111;
        }

        nav button {
            padding: 10px 16px;
            background: #1e88e5;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        nav button:hover {
            background: #1976d2;
        }

        .page {
            display: none;
            padding: 20px;
        }

        .active {
            display: block;
        }

        .asignatura-box {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            width: 90%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .eval-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        input {
            width: 80px;
            padding: 6px;
            border-radius: 5px;
            border: none;
            background: #2a2a2a;
            color: #fff;
        }

        .btn {
            padding: 8px 15px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-add {
            background: #43a047;
            color: white;
        }

        .btn-del {
            background: #e53935;
            color: white;
        }

        .btn-blue {
            background: #1e88e5;
            color: white;
        }

        .title {
            font-size: 20px;
            margin-bottom: 10px;
            text-align: center;
        }

        .result {
            margin-top: 8px;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }
    </style>
</head>

<body>

<header>Promedios UBB</header>

<nav>
    <button onclick="showPage('semestres')">Semestres</button>
    <button onclick="showPage('inicio')">Inicio</button>
</nav>

<!-- ===================== PÁGINA PRINCIPAL ===================== -->
<div id="inicio" class="page active">
    <h2 style="text-align:center;">Promedio general</h2>
    <p id="promedioGeneral" style="text-align:center; font-size:22px;">–</p>
</div>

<!-- ===================== PÁGINA DE SEMESTRES ===================== -->
<div id="semestres" class="page">

    <button class="btn btn-add" onclick="agregarSemestre()">+ Agregar semestre</button>
    <div id="contenedorSemestres"></div>

</div>

<script>
/* ============================
   CAMBIO DE PÁGINAS
============================ */
function showPage(id) {
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    document.getElementById(id).classList.add("active");
}

/* ======================================================
   SISTEMA DE SEMESTRES → cada semestre tiene asignaturas
====================================================== */
let semestres = JSON.parse(localStorage.getItem("semestresUBB") || "[]");

function guardar() {
    localStorage.setItem("semestresUBB", JSON.stringify(semestres));
    actualizarGeneral();
}

function agregarSemestre() {
    semestres.push({ asignaturas: [] });
    guardar();
    render();
}

function agregarAsignatura(idxSem) {
    semestres[idxSem].asignaturas.push({
        evaluaciones: []
    });
    guardar();
    render();
}

function agregarEvaluacion(idxSem, idxAsig) {
    semestres[idxSem].asignaturas[idxAsig].evaluaciones.push({
        nota: "",
        porcentaje: ""
    });
    guardar();
    render();
}

function eliminarSemestre(i) {
    semestres.splice(i, 1);
    guardar();
    render();
}

function eliminarAsignatura(i, j) {
    semestres[i].asignaturas.splice(j, 1);
    guardar();
    render();
}

function eliminarEvaluacion(i, j, k) {
    semestres[i].asignaturas[j].evaluaciones.splice(k, 1);
    guardar();
    render();
}

/* ===============================
   CÁLCULO DE PROMEDIOS
=============================== */
function calcularPromedioAsignatura(asig) {
    let sum = 0;
    let sumP = 0;

    for (let ev of asig.evaluaciones) {
        let n = parseFloat(ev.nota);
        let p = parseFloat(ev.porcentaje);

        if (!isNaN(n) && !isNaN(p)) {
            sum += n * (p / 100);
            sumP += p;
        }
    }

    if (sumP === 0) return { normal: 0, redondeado: 0 };

    let normal = sum;
    let r = Math.round(sum);

    return { normal, redondeado: r };
}

function actualizarGeneral() {
    let proms = [];

    for (let sem of semestres) {
        for (let asig of sem.asignaturas) {
            let p = calcularPromedioAsignatura(asig);
            proms.push(p.redondeado);
        }
    }

    if (proms.length === 0) {
        document.getElementById("promedioGeneral").innerText = "–";
        return;
    }

    let general = proms.reduce((a, b) => a + b) / proms.length;
    document.getElementById("promedioGeneral").innerText = general.toFixed(2);
}

/* ===============================
   RENDERIZADO DE SEMESTRES
=============================== */
function render() {
    let cont = document.getElementById("contenedorSemestres");
    cont.innerHTML = "";

    semestres.forEach((sem, i) => {
        let div = document.createElement("div");
        div.className = "asignatura-box";

        let html = `
            <div style="display:flex; justify-content:space-between;">
                <div class="title">Semestre ${i + 1}</div>
                <button class="btn btn-del" onclick="eliminarSemestre(${i})">X</button>
            </div>
        `;

        sem.asignaturas.forEach((asig, j) => {
            let prom = calcularPromedioAsignatura(asig);

            html += `
                <div class="asignatura-box" style="background:#222; margin-top:10px;">
                    <div style="display:flex; justify-content:space-between;">
                        <div class="title">Asignatura ${j + 1}</div>
                        <button class="btn btn-del" onclick="eliminarAsignatura(${i},${j})">X</button>
                    </div>

                    <div class="result">
                        Normal: ${prom.normal.toFixed(2)}<br>
                        Redondeado: ${prom.redondeado}
                    </div>
            `;

            asig.evaluaciones.forEach((ev, k) => {
                html += `
                    <div class="eval-row">
                        <div>Nota ${k + 1}</div>
                        <input type="number" value="${ev.nota}" placeholder="Nota" onchange="ev.nota=this.value; guardar();">
                        <input type="number" value="${ev.porcentaje}" placeholder="%" onchange="ev.porcentaje=this.value; guardar();">
                        <button class="btn btn-del" onclick="eliminarEvaluacion(${i},${j},${k})">X</button>
                    </div>
                `;
            });

            html += `
                    <button class="btn btn-add" onclick="agregarEvaluacion(${i},${j})">+ Agregar nota</button>
                </div>
            `;
        });

        html += `
            <button class="btn btn-blue" onclick="agregarAsignatura(${i})">+ Agregar asignatura</button>
        `;

        div.innerHTML = html;
        cont.appendChild(div);
    });

    actualizarGeneral();
}

render();
</script>

</body>
</html>
