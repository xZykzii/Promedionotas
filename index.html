<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Promedios por Semestre y Asignatura</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f0f0f;
      --card: #1a1a1a;
      --card-soft: #181818;
      --text: #e5e5e5;
      --text-soft: #bbbbbb;
      --input-bg: #262626;
      --input-border: #3d3d3d;
      --accent: #2563eb;
      --danger: #ef4444;
      --tag-ok-bg: #14532d;
      --tag-ok-text: #bbf7d0;
      --tag-bad-bg: #450a0a;
      --tag-bad-text: #fecaca;

      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      margin-top: 0;
      font-size: 1.6rem;
      text-align: center;
      color: var(--text);
    }

    /* Botones */
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .btn-primary { background: var(--accent); color: white; }
    .btn-secondary { background: #333; color: var(--text); }
    .btn-danger { background: var(--danger); color: white; }

    .auth-bar {
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .auth-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .top-bar {
      margin-bottom: 12px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Semestres (máx ~2 por fila) */
    .semesters-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
      gap: 18px;
    }

    .semester-card {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .semester-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .semester-header input[type="text"] {
      flex: 1;
      padding: 6px;
      border-radius: 8px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 0.95rem;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }

    .semester-subjects {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }

    .subject-card {
      background: var(--card-soft);
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .subject-header {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .subject-header input[type="text"] {
      flex: 1;
      padding: 5px;
      border-radius: 6px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 0.85rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th, td {
      border-bottom: 1px solid #2a2a2a;
      padding: 3px;
      text-align: left;
      color: var(--text);
    }

    .note-label {
      font-weight: 600;
      white-space: nowrap;
    }

    .percent-wrapper {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .percent-wrapper span {
      padding: 3px 6px;
      background: #333;
      border-radius: 4px;
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .subject-footer {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .subject-average {
      font-weight: bold;
      font-size: 0.85rem;
    }

    .semester-footer {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid #272727;
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .semester-average {
      font-weight: bold;
      font-size: 0.95rem;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      margin-left: 5px;
    }

    .tag-ok { background: var(--tag-ok-bg); color: var(--tag-ok-text); }
    .tag-bad { background: var(--tag-bad-bg); color: var(--tag-bad-text); }

    .global-box {
      margin-top: 20px;
      padding: 14px;
      border-radius: 12px;
      background: #111827;
      border: 1px solid #1e293b;
      font-size: 0.95rem;
    }

    .global-main {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Promedios por Semestre y Asignatura</h1>

    <div class="auth-bar">
      <div id="userInfo">Modo local (sin sesión)</div>
      <div class="auth-right">
        <button class="btn-primary" id="loginBtn">Iniciar sesión con Google</button>
        <button class="btn-secondary" id="logoutBtn" style="display:none;">Cerrar sesión</button>
      </div>
    </div>

    <div class="top-bar">
      <button class="btn-primary" id="addSemesterBtn">Agregar semestre</button>
      <button class="btn-secondary" id="recalcAllBtn">Recalcular</button>
      <button class="btn-danger" id="clearAllBtn">Borrar todo</button>
    </div>

    <div class="semesters-container" id="semestersContainer"></div>

    <div class="global-box">
      Promedio general (todas las asignaturas de todos los semestres, usando promedios redondeados):
      <div class="global-main" id="globalAverage">-</div>
    </div>
  </div>

  <script type="module">
    /* ========================
       Firebase imports
    ========================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /* ========================
       CONFIGURA TU FIREBASE
    ========================= */
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      projectId: "TU_PROJECT_ID"
      // agrega otros campos si tu proyecto los usa (appId, etc.)
    };

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(appFB);

    /* ========================
       DOM
    ========================= */
    const semestersContainer = document.getElementById("semestersContainer");
    const globalAverageEl = document.getElementById("globalAverage");

    const addSemesterBtn = document.getElementById("addSemesterBtn");
    const recalcAllBtn = document.getElementById("recalcAllBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");

    const userInfoEl = document.getElementById("userInfo");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const LOCAL_STORAGE_KEY = "promedios_semestres_v1";
    let currentUser = null;

    /* ========================
       Redondeo especial
       (decimal >= 0.45 → sube)
    ========================= */
    function customRound(value) {
      const decimal = value - Math.floor(value);
      return decimal >= 0.45 ? Math.ceil(value) : Math.floor(value);
    }

    function handleChange() {
      saveData();
      calculateAll();
    }

    function updateNoteLabels(subjectCard) {
      const rows = subjectCard.querySelectorAll("tbody tr");
      rows.forEach((tr, idx) => {
        const label = tr.querySelector(".note-label");
        if (label) label.textContent = "Nota " + (idx + 1);
      });
    }

    /* ========================
       Crear Subject (Asignatura)
    ========================= */
    function createSubjectCard(subjectsContainerEl, subjectData = {}) {
      const subjectCard = document.createElement("div");
      subjectCard.className = "subject-card";

      const header = document.createElement("div");
      header.className = "subject-header";

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "Nombre asignatura";
      nameInput.value = subjectData.name || "";
      nameInput.addEventListener("input", handleChange);

      const deleteSubjectBtn = document.createElement("button");
      deleteSubjectBtn.textContent = "Eliminar ramo";
      deleteSubjectBtn.className = "btn-danger";
      deleteSubjectBtn.style.fontSize = "0.7rem";
      deleteSubjectBtn.addEventListener("click", () => {
        subjectCard.remove();
        handleChange();
      });

      header.appendChild(nameInput);
      header.appendChild(deleteSubjectBtn);

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th></th><th>Nota</th><th>%</th><th></th>
          </tr>
        </thead>
      `;
      const tbody = document.createElement("tbody");
      table.appendChild(tbody);

      function addEval(row = {}) {
        const tr = document.createElement("tr");

        const tdLabel = document.createElement("td");
        tdLabel.className = "note-label";

        const tdGrade = document.createElement("td");
        const gradeInput = document.createElement("input");
        gradeInput.type = "number";
        gradeInput.min = "1";
        gradeInput.max = "7";
        gradeInput.step = "0.1";
        gradeInput.placeholder = "Nota";
        gradeInput.value = row.grade || "";
        gradeInput.addEventListener("input", handleChange);
        tdGrade.appendChild(gradeInput);

        const tdPercent = document.createElement("td");
        const pWrap = document.createElement("div");
        pWrap.className = "percent-wrapper";
        const percentInput = document.createElement("input");
        percentInput.type = "number";
        percentInput.min = "0";
        percentInput.step = "0.1";
        percentInput.placeholder = "%";
        percentInput.value = row.percent || "";
        percentInput.addEventListener("input", handleChange);
        const percentSpan = document.createElement("span");
        percentSpan.textContent = "%";
        pWrap.appendChild(percentInput);
        pWrap.appendChild(percentSpan);
        tdPercent.appendChild(pWrap);

        const tdActions = document.createElement("td");
        const delEvalBtn = document.createElement("button");
        delEvalBtn.textContent = "X";
        delEvalBtn.className = "btn-danger";
        delEvalBtn.style.fontSize = "0.7rem";
        delEvalBtn.style.padding = "2px 6px";
        delEvalBtn.addEventListener("click", () => {
          tr.remove();
          updateNoteLabels(subjectCard);
          handleChange();
        });
        tdActions.appendChild(delEvalBtn);

        tr.appendChild(tdLabel);
        tr.appendChild(tdGrade);
        tr.appendChild(tdPercent);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
        updateNoteLabels(subjectCard);
      }

      if (subjectData.evaluations && subjectData.evaluations.length) {
        subjectData.evaluations.forEach(ev => addEval(ev));
      } else {
        addEval();
      }

      const addEvalBtn = document.createElement("button");
      addEvalBtn.textContent = "Agregar nota";
      addEvalBtn.className = "btn-secondary";
      addEvalBtn.style.fontSize = "0.75rem";
      addEvalBtn.addEventListener("click", () => {
        addEval();
        handleChange();
      });

      const footer = document.createElement("div");
      footer.className = "subject-footer";
      footer.innerHTML = `
        Promedio asignatura:
        <span class="subject-average">-</span><br>
        Suma %: <strong class="subject-weight">0%</strong>
        <span class="subject-tag tag"></span>
      `;

      subjectCard.appendChild(header);
      subjectCard.appendChild(table);
      subjectCard.appendChild(addEvalBtn);
      subjectCard.appendChild(footer);

      subjectsContainerEl.appendChild(subjectCard);
      updateNoteLabels(subjectCard);
    }

    /* ========================
       Crear Semester
    ========================= */
    function createSemesterCard(semData = {}) {
      const semesterCard = document.createElement("div");
      semesterCard.className = "semester-card";

      const header = document.createElement("div");
      header.className = "semester-header";

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "Nombre semestre (Ej: 2025-1)";
      nameInput.value = semData.name || "";
      nameInput.addEventListener("input", handleChange);

      const delSemBtn = document.createElement("button");
      delSemBtn.textContent = "Eliminar semestre";
      delSemBtn.className = "btn-danger";
      delSemBtn.style.fontSize = "0.75rem";
      delSemBtn.addEventListener("click", () => {
        semesterCard.remove();
        handleChange();
      });

      header.appendChild(nameInput);
      header.appendChild(delSemBtn);

      const subjectsWrapper = document.createElement("div");
      subjectsWrapper.className = "semester-subjects";

      if (semData.subjects && semData.subjects.length) {
        semData.subjects.forEach(sub => createSubjectCard(subjectsWrapper, sub));
      } else {
        createSubjectCard(subjectsWrapper);
      }

      const addSubjectBtn = document.createElement("button");
      addSubjectBtn.textContent = "Agregar asignatura";
      addSubjectBtn.className = "btn-primary";
      addSubjectBtn.style.fontSize = "0.8rem";
      addSubjectBtn.addEventListener("click", () => {
        createSubjectCard(subjectsWrapper);
        handleChange();
      });

      const semFooter = document.createElement("div");
      semFooter.className = "semester-footer";
      semFooter.innerHTML = `
        Promedio semestre:
        <span class="semester-average">-</span>
      `;

      semesterCard.appendChild(header);
      semesterCard.appendChild(subjectsWrapper);
      semesterCard.appendChild(addSubjectBtn);
      semesterCard.appendChild(semFooter);

      semestersContainer.appendChild(semesterCard);
    }

    /* ========================
       Render desde datos
    ========================= */
    function renderFromData(semestersData) {
      semestersContainer.innerHTML = "";
      if (Array.isArray(semestersData) && semestersData.length) {
        semestersData.forEach(sem => createSemesterCard(sem));
      } else {
        createSemesterCard();
      }
      calculateAll();
    }

    /* ========================
       Cargar local / remoto
    ========================= */
    function loadFromLocal() {
      const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (!raw) {
        renderFromData(null);
        return;
      }
      try {
        const data = JSON.parse(raw);
        renderFromData(data);
      } catch {
        renderFromData(null);
      }
    }

    async function loadFromRemote(user) {
      try {
        const ref = doc(db, "promedios_semestres", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const data = snap.data().semesters || [];
          renderFromData(data);
        } else {
          renderFromData(null);
        }
      } catch (err) {
        console.error("Error cargando desde Firestore, uso local:", err);
        loadFromLocal();
      }
    }

    /* ========================
       Recolección y guardado
    ========================= */
    function collectData() {
      const semestersData = [];
      semestersContainer.querySelectorAll(".semester-card").forEach(semCard => {
        const semName = semCard.querySelector(".semester-header input").value;
        const subjectsData = [];
        semCard.querySelectorAll(".subject-card").forEach(subCard => {
          const subName = subCard.querySelector(".subject-header input").value;
          const evals = [];
          subCard.querySelectorAll("tbody tr").forEach(tr => {
            const inputs = tr.querySelectorAll("input");
            const grade = inputs[0].value;
            const percent = inputs[1].value;
            evals.push({ grade, percent });
          });
          subjectsData.push({ name: subName, evaluations: evals });
        });
        semestersData.push({ name: semName, subjects: subjectsData });
      });
      return semestersData;
    }

    function saveData() {
      const semestersData = collectData();
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(semestersData));
      if (currentUser) {
        const ref = doc(db, "promedios_semestres", currentUser.uid);
        setDoc(ref, { semesters: semestersData }, { merge: true }).catch(err =>
          console.error("Error guardando en Firestore:", err)
        );
      }
    }

    /* ========================
       Cálculo de promedios
    ========================= */
    function calculateAll() {
      let totalSubjectsAll = 0;
      let sumNormalAll = 0;
      let sumRoundedAll = 0;

      semestersContainer.querySelectorAll(".semester-card").forEach(semCard => {
        let semSubjectCount = 0;
        let semSumNormal = 0;
        let semSumRounded = 0;

        semCard.querySelectorAll(".subject-card").forEach(subCard => {
          const rows = subCard.querySelectorAll("tbody tr");
          let totalW = 0;
          let weighted = 0;

          rows.forEach(tr => {
            const inputs = tr.querySelectorAll("input");
            const grade = parseFloat(inputs[0].value);
            const percent = parseFloat(inputs[1].value);
            if (!isNaN(grade) && !isNaN(percent)) {
              totalW += percent;
              weighted += grade * percent;
            }
          });

          const avgNode = subCard.querySelector(".subject-average");
          const wNode = subCard.querySelector(".subject-weight");
          const tagNode = subCard.querySelector(".subject-tag");

          if (totalW > 0) {
            const avg = weighted / totalW;
            const rounded = customRound(avg);

            avgNode.innerHTML = `
              Normal: ${avg.toFixed(2)}<br>
              Redondeado: <strong>${rounded}</strong>
            `;

            wNode.textContent = totalW.toFixed(1) + "%";

            if (Math.abs(totalW - 100) < 1) {
              tagNode.textContent = "OK";
              tagNode.className = "subject-tag tag tag-ok";
            } else {
              tagNode.textContent = "No suma 100%";
              tagNode.className = "subject-tag tag tag-bad";
            }

            semSubjectCount++;
            semSumNormal += avg;
            semSumRounded += rounded;

            totalSubjectsAll++;
            sumNormalAll += avg;
            sumRoundedAll += rounded;
          } else {
            avgNode.textContent = "-";
            wNode.textContent = "0%";
            tagNode.textContent = "";
            tagNode.className = "subject-tag tag";
          }
        });

        const semAvgNode = semCard.querySelector(".semester-average");
        if (semSubjectCount > 0) {
          const semAvgNormal = semSumNormal / semSubjectCount;
          const semAvgRounded = semSumRounded / semSubjectCount;
          semAvgNode.innerHTML = `
            Normal: ${semAvgNormal.toFixed(2)}<br>
            Con redondeados: <strong>${semAvgRounded.toFixed(2)}</strong>
          `;
        } else {
          semAvgNode.textContent = "-";
        }
      });

      if (totalSubjectsAll === 0) {
        globalAverageEl.textContent = "-";
      } else {
        const generalNormal = sumNormalAll / totalSubjectsAll;
        const generalRounded = sumRoundedAll / totalSubjectsAll;
        globalAverageEl.innerHTML = `
          Normal: ${generalNormal.toFixed(2)}<br>
          Con redondeados: <strong>${generalRounded.toFixed(2)}</strong>
        `;
      }
    }

    /* ========================
       Auth Google
    ========================= */
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error("Error al iniciar sesión:", err);
        alert("No se pudo iniciar sesión con Google.");
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (err) {
        console.error("Error al cerrar sesión:", err);
      }
    });

    onAuthStateChanged(auth, async user => {
      currentUser = user;
      if (user) {
        userInfoEl.textContent = `Sesión: ${user.displayName || user.email}`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        await loadFromRemote(user);
      } else {
        userInfoEl.textContent = "Modo local (sin sesión)";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        loadFromLocal();
      }
    });

    /* ========================
       Botones generales
    ========================= */
    addSemesterBtn.addEventListener("click", () => {
      createSemesterCard();
      handleChange();
    });

    recalcAllBtn.addEventListener("click", () => {
      calculateAll();
    });

    clearAllBtn.addEventListener("click", () => {
      if (!confirm("¿Seguro que quieres borrar todo?")) return;
      localStorage.removeItem(LOCAL_STORAGE_KEY);
      if (currentUser) {
        const ref = doc(db, "promedios_semestres", currentUser.uid);
        setDoc(ref, { semesters: [] }, { merge: true }).catch(console.error);
      }
      semestersContainer.innerHTML = "";
      createSemesterCard();
      calculateAll();
    });

    /* ========================
       Inicio
    ========================= */
    // Por si el onAuthStateChanged se demora un poco
    loadFromLocal();
  </script>
</body>
</html>
