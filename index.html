<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Promedios por Asignatura</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f0f0f;
      --card: #1a1a1a;
      --text: #e5e5e5;
      --text-soft: #bbbbbb;
      --input-bg: #262626;
      --input-border: #3d3d3d;
      --accent: #2563eb;
      --danger: #ef4444;
      --tag-ok-bg: #14532d;
      --tag-ok-text: #bbf7d0;
      --tag-bad-bg: #450a0a;
      --tag-bad-text: #fecaca;

      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
    }

    h1 {
      margin-top: 0;
      font-size: 1.6rem;
      text-align: center;
      color: var(--text);
    }

    /* Buttons */
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .btn-primary { background: var(--accent); color: white; }
    .btn-secondary { background: #333; color: var(--text); }
    .btn-danger { background: var(--danger); color: white; }

    .top-bar {
      margin-bottom: 16px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* 2 cards por fila máximo */
    .subjects-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 16px;
    }

    .subject-card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .subject-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      border-bottom: 1px solid #2a2a2a;
      padding: 4px;
      text-align: left;
      color: var(--text);
    }

    .note-label {
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
    }

    .percent-wrapper {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .percent-wrapper span {
      padding: 4px 6px;
      background: #333;
      border-radius: 4px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .subject-footer {
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .subject-average {
      font-weight: bold;
      font-size: 1rem;
      color: var(--text);
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      margin-left: 5px;
    }

    .tag-ok { background: var(--tag-ok-bg); color: var(--tag-ok-text); }
    .tag-bad { background: var(--tag-bad-bg); color: var(--tag-bad-text); }

    .global-box {
      margin-top: 20px;
      padding: 14px;
      border-radius: 12px;
      background: #111827;
      border: 1px solid #1e293b;
      font-size: 1rem;
    }

    .global-main {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Promedios por Asignatura</h1>

    <div class="top-bar">
      <button class="btn-primary" id="addSubjectBtn">Agregar asignatura</button>
      <button class="btn-secondary" id="recalcAllBtn">Recalcular</button>
      <button class="btn-danger" id="clearAllBtn">Borrar todo</button>
    </div>

    <div class="subjects-container" id="subjectsContainer"></div>

    <div class="global-box">
      Promedio general:
      <div class="global-main" id="globalAverage">-</div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "promedios_dark_v1";
    const subjectsContainer = document.getElementById("subjectsContainer");
    const globalAverageEl = document.getElementById("globalAverage");

    function handleChange() {
      saveToStorage();
      calculateAll();
    }

    function updateNoteLabels(card) {
      const rows = card.querySelectorAll("tbody tr");
      rows.forEach((tr, idx) => {
        const label = tr.querySelector(".note-label");
        if (label) label.textContent = "Nota " + (idx + 1);
      });
    }

    /* === Crear tarjeta de asignatura === */
    function createSubjectCard(data = {}) {
      const card = document.createElement("div");
      card.className = "subject-card";

      const header = document.createElement("div");
      header.className = "subject-header";

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "Nombre asignatura";
      nameInput.value = data.name || "";
      nameInput.addEventListener("input", handleChange);

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Eliminar";
      deleteBtn.className = "btn-danger";
      deleteBtn.style.fontSize = "0.75rem";
      deleteBtn.addEventListener("click", () => { card.remove(); handleChange(); });

      header.appendChild(nameInput);
      header.appendChild(deleteBtn);

      /* ===== Tabla ===== */
      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th></th><th>Nota</th><th>%</th><th></th>
          </tr>
        </thead>
      `;

      const tbody = document.createElement("tbody");
      table.appendChild(tbody);

      function addEval(row = {}) {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="note-label"></td>
          <td><input type="number" min="1" max="7" step="0.1" value="${row.grade || ""}"></td>
          <td>
            <div class="percent-wrapper">
              <input type="number" min="0" step="0.1" value="${row.percent || ""}">
              <span>%</span>
            </div>
          </td>
          <td><button class="btn-danger" style="font-size:0.75rem;padding:2px 6px;">X</button></td>
        `;

        tr.querySelectorAll("input").forEach(i => i.addEventListener("input", handleChange));
        tr.querySelector("button").addEventListener("click", () => { tr.remove(); updateNoteLabels(card); handleChange(); });

        tbody.appendChild(tr);
        updateNoteLabels(card);
      }

      if (data.evaluations) data.evaluations.forEach(addEval);
      else addEval();

      const addEvalBtn = document.createElement("button");
      addEvalBtn.textContent = "Agregar nota";
      addEvalBtn.className = "btn-secondary";
      addEvalBtn.style.fontSize = "0.8rem";
      addEvalBtn.addEventListener("click", () => { addEval(); handleChange(); });

      /* === Footer === */
      const footer = document.createElement("div");
      footer.className = "subject-footer";
      footer.innerHTML = `
        Promedio asignatura: <span class="subject-average">-</span><br>
        Suma %: <strong class="subject-weight">0%</strong> <span class="subject-tag tag"></span>
      `;

      card.appendChild(header);
      card.appendChild(table);
      card.appendChild(addEvalBtn);
      card.appendChild(footer);

      subjectsContainer.appendChild(card);
      updateNoteLabels(card);
    }

    /* === Guardar datos === */
    function saveToStorage() {
      const subjectsData = [];

      subjectsContainer.querySelectorAll(".subject-card").forEach(card => {
        const name = card.querySelector(".subject-header input").value;
        const evals = [];

        card.querySelectorAll("tbody tr").forEach(tr => {
          const inputs = tr.querySelectorAll("input");
          evals.push({
            grade: inputs[0].value,
            percent: inputs[1].value
          });
        });

        subjectsData.push({ name, evaluations: evals });
      });

      localStorage.setItem(STORAGE_KEY, JSON.stringify(subjectsData));
    }

    /* === Cargar data === */
    function loadFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return createSubjectCard();

      try {
        const data = JSON.parse(raw);
        data.forEach(d => createSubjectCard(d));
      } catch {
        createSubjectCard();
      }
    }

    /* === Calcular promedios === */
    function calculateAll() {
      let subjects = 0;
      let sumAvg = 0;

      subjectsContainer.querySelectorAll(".subject-card").forEach(card => {
        const rows = card.querySelectorAll("tbody tr");
        let totalW = 0;
        let weighted = 0;

        rows.forEach(tr => {
          const inputs = tr.querySelectorAll("input");
          const grade = parseFloat(inputs[0].value);
          const percent = parseFloat(inputs[1].value);

          if (!isNaN(grade) && !isNaN(percent)) {
            totalW += percent;
            weighted += grade * percent;
          }
        });

        const avgNode = card.querySelector(".subject-average");
        const wNode = card.querySelector(".subject-weight");
        const tagNode = card.querySelector(".subject-tag");

        if (totalW > 0) {
          const avg = weighted / totalW;
          avgNode.textContent = avg.toFixed(2);
          wNode.textContent = totalW.toFixed(1) + "%";

          if (Math.abs(totalW - 100) < 1) {
            tagNode.textContent = "OK";
            tagNode.className = "subject-tag tag tag-ok";
          } else {
            tagNode.textContent = "No suma 100%";
            tagNode.className = "subject-tag tag tag-bad";
          }

          subjects++;
          sumAvg += avg;
        } else {
          avgNode.textContent = "-";
          wNode.textContent = "0%";
          tagNode.textContent = "";
        }
      });

      globalAverageEl.textContent = subjects ? (sumAvg / subjects).toFixed(2) : "-";
    }

    /* === Botones === */
    document.getElementById("addSubjectBtn").onclick = () => { createSubjectCard(); handleChange(); };
    document.getElementById("recalcAllBtn").onclick = calculateAll;
    document.getElementById("clearAllBtn").onclick = () => {
      if (confirm("¿Seguro?")) {
        localStorage.removeItem(STORAGE_KEY);
        subjectsContainer.innerHTML = "";
        createSubjectCard();
        calculateAll();
      }
    };

    /* START */
    loadFromStorage();
    calculateAll();
  </script>
</body>
</html>
