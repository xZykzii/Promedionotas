<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Promedios por Asignatura</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f0f0f;
      --card: #1a1a1a;
      --text: #e5e5e5;
      --text-soft: #bbbbbb;
      --input-bg: #262626;
      --input-border: #3d3d3d;
      --accent: #2563eb;
      --danger: #ef4444;
      --tag-ok-bg: #14532d;
      --tag-ok-text: #bbf7d0;
      --tag-bad-bg: #450a0a;
      --tag-bad-text: #fecaca;

      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
    }

    h1 {
      margin-top: 0;
      font-size: 1.6rem;
      text-align: center;
      color: var(--text);
    }

    /* Botones */
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .btn-primary { background: var(--accent); color: white; }
    .btn-secondary { background: #333; color: var(--text); }
    .btn-danger { background: var(--danger); color: white; }

    .top-bar {
      margin-bottom: 8px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .auth-bar {
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .auth-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Tarjetas de ramos: máximo ~2 por fila */
    .subjects-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 16px;
    }

    .subject-card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .subject-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      border-bottom: 1px solid #2a2a2a;
      padding: 4px;
      text-align: left;
      color: var(--text);
    }

    .note-label {
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
    }

    .percent-wrapper {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .percent-wrapper span {
      padding: 4px 6px;
      background: #333;
      border-radius: 4px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .subject-footer {
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .subject-average {
      font-weight: bold;
      font-size: 0.95rem;
      color: var(--text);
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      margin-left: 5px;
    }

    .tag-ok { background: var(--tag-ok-bg); color: var(--tag-ok-text); }
    .tag-bad { background: var(--tag-bad-bg); color: var(--tag-bad-text); }

    .global-box {
      margin-top: 20px;
      padding: 14px;
      border-radius: 12px;
      background: #111827;
      border: 1px solid #1e293b;
      font-size: 0.95rem;
    }

    .global-main {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Promedios por Asignatura</h1>

    <div class="auth-bar">
      <div id="userInfo">Modo local (sin sesión)</div>
      <div class="auth-right">
        <button class="btn-primary" id="loginBtn">Iniciar sesión con Google</button>
        <button class="btn-secondary" id="logoutBtn" style="display:none;">Cerrar sesión</button>
      </div>
    </div>

    <div class="top-bar">
      <button class="btn-primary" id="addSubjectBtn">Agregar asignatura</button>
      <button class="btn-secondary" id="recalcAllBtn">Recalcular</button>
      <button class="btn-danger" id="clearAllBtn">Borrar todo</button>
    </div>

    <div class="subjects-container" id="subjectsContainer"></div>

    <div class="global-box">
      Promedio general (usando promedios redondeados de cada ramo):
      <div class="global-main" id="globalAverage">-</div>
    </div>
  </div>

  <!-- Lógica de la app + Firebase -->
  <script type="module">
    /* ====== IMPORTS FIREBASE (v10) ====== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /* ====== CONFIGURA TU PROYECTO AQUÍ ====== */
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      projectId: "TU_PROJECT_ID",
      // si usas otros campos (storageBucket, appId, etc.) los agregas acá
    };

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(appFB);

    /* ====== DOM ELEMENTS ====== */
    const subjectsContainer = document.getElementById("subjectsContainer");
    const globalAverageEl = document.getElementById("globalAverage");
    const addSubjectBtn = document.getElementById("addSubjectBtn");
    const recalcAllBtn = document.getElementById("recalcAllBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const userInfoEl = document.getElementById("userInfo");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const LOCAL_STORAGE_KEY = "promedios_dark_v2";

    let currentUser = null; // usuario logeado

    // Redondeo especial: decimal >= 0.45 sube
    function customRound(value) {
      const decimal = value - Math.floor(value);
      return decimal >= 0.45 ? Math.ceil(value) : Math.floor(value);
    }

    function handleChange() {
      saveData();      // guarda en local y si hay usuario, en Firestore
      calculateAll();  // recalcula promedios
    }

    function updateNoteLabels(card) {
      const rows = card.querySelectorAll("tbody tr");
      rows.forEach((tr, idx) => {
        const label = tr.querySelector(".note-label");
        if (label) label.textContent = "Nota " + (idx + 1);
      });
    }

    /* ====== CREAR TARJETA DE ASIGNATURA ====== */
    function createSubjectCard(data = {}) {
      const card = document.createElement("div");
      card.className = "subject-card";

      const header = document.createElement("div");
      header.className = "subject-header";

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "Nombre asignatura";
      nameInput.value = data.name || "";
      nameInput.addEventListener("input", handleChange);

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Eliminar";
      deleteBtn.className = "btn-danger";
      deleteBtn.style.fontSize = "0.75rem";
      deleteBtn.addEventListener("click", () => {
        card.remove();
        handleChange();
      });

      header.appendChild(nameInput);
      header.appendChild(deleteBtn);

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th></th><th>Nota</th><th>%</th><th></th>
          </tr>
        </thead>
      `;
      const tbody = document.createElement("tbody");
      table.appendChild(tbody);

      function addEval(row = {}) {
        const tr = document.createElement("tr");

        const tdLabel = document.createElement("td");
        tdLabel.className = "note-label";

        const tdGrade = document.createElement("td");
        const gradeInput = document.createElement("input");
        gradeInput.type = "number";
        gradeInput.min = "1";
        gradeInput.max = "7";
        gradeInput.step = "0.1";
        gradeInput.placeholder = "Nota";
        gradeInput.value = row.grade || "";
        gradeInput.addEventListener("input", handleChange);
        tdGrade.appendChild(gradeInput);

        const tdPercent = document.createElement("td");
        const pWrap = document.createElement("div");
        pWrap.className = "percent-wrapper";
        const percentInput = document.createElement("input");
        percentInput.type = "number";
        percentInput.min = "0";
        percentInput.step = "0.1";
        percentInput.placeholder = "%";
        percentInput.value = row.percent || "";
        percentInput.addEventListener("input", handleChange);
        const percentSpan = document.createElement("span");
        percentSpan.textContent = "%";
        pWrap.appendChild(percentInput);
        pWrap.appendChild(percentSpan);
        tdPercent.appendChild(pWrap);

        const tdActions = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "X";
        delBtn.className = "btn-danger";
        delBtn.style.fontSize = "0.75rem";
        delBtn.style.padding = "2px 6px";
        delBtn.addEventListener("click", () => {
          tr.remove();
          updateNoteLabels(card);
          handleChange();
        });
        tdActions.appendChild(delBtn);

        tr.appendChild(tdLabel);
        tr.appendChild(tdGrade);
        tr.appendChild(tdPercent);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
        updateNoteLabels(card);
      }

      if (data.evaluations && data.evaluations.length) {
        data.evaluations.forEach(ev => addEval(ev));
      } else {
        addEval();
      }

      const addEvalBtn = document.createElement("button");
      addEvalBtn.textContent = "Agregar nota";
      addEvalBtn.className = "btn-secondary";
      addEvalBtn.style.fontSize = "0.8rem";
      addEvalBtn.addEventListener("click", () => {
        addEval();
        handleChange();
      });

      const footer = document.createElement("div");
      footer.className = "subject-footer";
      footer.innerHTML = `
        Promedio asignatura:
        <span class="subject-average">-</span><br>
        Suma %: <strong class="subject-weight">0%</strong>
        <span class="subject-tag tag"></span>
      `;

      card.appendChild(header);
      card.appendChild(table);
      card.appendChild(addEvalBtn);
      card.appendChild(footer);

      subjectsContainer.appendChild(card);
      updateNoteLabels(card);
    }

    /* ====== HIDRATAR UI DESDE DATA ====== */
    function renderFromData(subjectsData) {
      subjectsContainer.innerHTML = "";
      if (Array.isArray(subjectsData) && subjectsData.length) {
        subjectsData.forEach(d => createSubjectCard(d));
      } else {
        createSubjectCard();
      }
      calculateAll();
    }

    /* ====== LECTURA LOCAL / REMOTA ====== */
    function loadFromLocal() {
      const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (!raw) {
        renderFromData(null);
        return;
      }
      try {
        const data = JSON.parse(raw);
        renderFromData(data);
      } catch {
        renderFromData(null);
      }
    }

    async function loadFromRemote(user) {
      try {
        const ref = doc(db, "promedios", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const data = snap.data().subjects || [];
          renderFromData(data);
        } else {
          renderFromData(null);
        }
      } catch (err) {
        console.error("Error cargando desde Firestore, uso local:", err);
        loadFromLocal();
      }
    }

    /* ====== GUARDAR (LOCAL + FIRESTORE SI HAY USER) ====== */
    function collectSubjectsData() {
      const subjectsData = [];
      subjectsContainer.querySelectorAll(".subject-card").forEach(card => {
        const name = card.querySelector(".subject-header input").value;
        const evals = [];
        card.querySelectorAll("tbody tr").forEach(tr => {
          const inputs = tr.querySelectorAll("input");
          const grade = inputs[0].value;
          const percent = inputs[1].value;
          evals.push({ grade, percent });
        });
        subjectsData.push({ name, evaluations: evals });
      });
      return subjectsData;
    }

    function saveData() {
      const subjectsData = collectSubjectsData();
      // Local
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(subjectsData));
      // Remoto (si hay usuario)
      if (currentUser) {
        const ref = doc(db, "promedios", currentUser.uid);
        setDoc(ref, { subjects: subjectsData }, { merge: true }).catch(err =>
          console.error("Error guardando en Firestore:", err)
        );
      }
    }

    /* ====== CÁLCULO DE PROMEDIOS ====== */
    function calculateAll() {
      let subjects = 0;
      let sumNormal = 0;
      let sumRounded = 0;

      subjectsContainer.querySelectorAll(".subject-card").forEach(card => {
        const rows = card.querySelectorAll("tbody tr");
        let totalW = 0;
        let weighted = 0;

        rows.forEach(tr => {
          const inputs = tr.querySelectorAll("input");
          const grade = parseFloat(inputs[0].value);
          const percent = parseFloat(inputs[1].value);
          if (!isNaN(grade) && !isNaN(percent)) {
            totalW += percent;
            weighted += grade * percent;
          }
        });

        const avgNode = card.querySelector(".subject-average");
        const wNode = card.querySelector(".subject-weight");
        const tagNode = card.querySelector(".subject-tag");

        if (totalW > 0) {
          const avg = weighted / totalW;        // promedio normal
          const rounded = customRound(avg);     // redondeado

          avgNode.innerHTML = `
            Normal: ${avg.toFixed(2)}<br>
            Redondeado: <strong>${rounded}</strong>
          `;

          wNode.textContent = totalW.toFixed(1) + "%";

          if (Math.abs(totalW - 100) < 1) {
            tagNode.textContent = "OK";
            tagNode.className = "subject-tag tag tag-ok";
          } else {
            tagNode.textContent = "No suma 100%";
            tagNode.className = "subject-tag tag tag-bad";
          }

          subjects++;
          sumNormal += avg;
          sumRounded += rounded;
        } else {
          avgNode.textContent = "-";
          wNode.textContent = "0%";
          tagNode.textContent = "";
          tagNode.className = "subject-tag tag";
        }
      });

      if (subjects === 0) {
        globalAverageEl.textContent = "-";
      } else {
        const generalNormal = sumNormal / subjects;
        const generalRounded = sumRounded / subjects;
        globalAverageEl.innerHTML = `
          Normal: ${generalNormal.toFixed(2)}<br>
          Con redondeados: <strong>${generalRounded.toFixed(2)}</strong>
        `;
      }
    }

    /* ====== LOGIN / LOGOUT GOOGLE ====== */
    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error("Error al iniciar sesión:", err);
        alert("No se pudo iniciar sesión con Google.");
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (err) {
        console.error("Error al cerrar sesión:", err);
      }
    });

    onAuthStateChanged(auth, async user => {
      currentUser = user;
      if (user) {
        userInfoEl.textContent = `Sesión: ${user.displayName || user.email}`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        await loadFromRemote(user);
      } else {
        userInfoEl.textContent = "Modo local (sin sesión)";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        loadFromLocal();
      }
    });

    /* ====== BOTONES GENERALES ====== */
    addSubjectBtn.addEventListener("click", () => {
      createSubjectCard();
      handleChange();
    });

    recalcAllBtn.addEventListener("click", () => {
      calculateAll();
    });

    clearAllBtn.addEventListener("click", () => {
      if (!confirm("¿Seguro que quieres borrar todo?")) return;
      localStorage.removeItem(LOCAL_STORAGE_KEY);
      if (currentUser) {
        const ref = doc(db, "promedios", currentUser.uid);
        setDoc(ref, { subjects: [] }, { merge: true }).catch(console.error);
      }
      subjectsContainer.innerHTML = "";
      createSubjectCard();
      calculateAll();
    });

    /* ====== INICIO (modo sin sesión hasta que Firebase cargue estado) ====== */
    // onAuthStateChanged ya llama a loadFromLocal() si no hay usuario,
    // pero por si se demora, mostramos algo funcional:
    loadFromLocal();
  </script>
</body>
</html>
